CREATE OR REPLACE TRIGGER CONSERVA_SEGNALAZIONI
AFTER DELETE ON UTENTI
FOR EACH ROW
DECLARE 
    rNumeroDiTelefono UTENTI.NumeroDiTelefono%TYPE
    rNome UTENTI.Nome%TYPE; 
    rCognome UTENTI.Cognome%TYPE; 

    rCodice SEGNALAZIONI.Codice%TYPE; 
    rTipologiaEmergenza SEGNALAZIONI.TipologiaEmergenza%TYPE; 

    rVia RICHIESTE.Via%TYPE;
    rNumeroCivico RICHIESTE.NumeroCivico%TYPE;
    rCittà RICHIESTE.Città%TYPE;
    rProvincia RICHIESTE.Provincia%TYPE; 
    rCAP RICHIESTE.CAP%TYPE; 
    rTStamp RICHIESTE.Data_Ora%TYPE;

    cursor r_set IS SELECT 	U.NumeroDiTelefono, U.Nome, U.Cognome,
                            S.Codice, S.TipologiaEmergenze,
                            R.Via, R.NumeroCivico, R.Città, R.Provincia, R.CAP, R.Data_Ora
    FROM UTENTI U,  SEGNALAZIONI S, RICHIESTE R
    WHERE 	R.NumTelefonicoUtente=U.NumeroDiTelefono AND
            R.NumTelefonicoUtente=:old.NumeroDiTelefono AND 	
            S.Codice=R.CodiceEmergenza; 
BEGIN 
    OPEN r_set; 
    LOOP 
        FECTH r_set INTO    rNumeroDiTelefono, rNome, rCognome,
                            rCodice, rTipologiaEmergenza,
                            rVia, rNumeroCivico, rCittà, rProvincia, rCAP, rData_Ora;
        INSERT INTO STORICO_SEGNALAZIONI
        VALUES( rNumeroDiTelefono, rNome, rCognome, rCodice, rTipologiaEmergenza, rVia, rNumeroCivico, rCittà, rProvincia, rCAP, rData_Ora); 
    END LOOP; 
    CLOSE r_set; 
    DELETE FROM RICHIESTE WHERE R.IdPaziente=:old.ld;		-- TODO
END;