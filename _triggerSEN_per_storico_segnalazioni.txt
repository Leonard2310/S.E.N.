CREATE OR REPLACE TRIGGER CONSERVA_SEGNALAZIONI
    AFTER DELETE ON UTENTI
    FOR EACH ROW
    DECLARE 
        tNumeroDiTelefono UTENTI.NumeroDiTelefono%TYPE;
        tNome UTENTI.Nome%TYPE; 
        tCognome UTENTI.Cognome%TYPE; 
    
        tCodice SEGNALAZIONI.Codice%TYPE; 
        tTipologiaEmergenza SEGNALAZIONI.TipologiaEmergenza%TYPE; 
    
        tVia RICHIESTE.Via%TYPE;
        tNumeroCivico RICHIESTE.NumeroCivico%TYPE;
        tCittà RICHIESTE.Città%TYPE;
        tProvincia RICHIESTE.Provincia%TYPE; 
        tCAP RICHIESTE.CAP%TYPE; 
        tData_Ora RICHIESTE.Data_Ora%TYPE;
    
        cursor t_set IS SELECT 	U.NumeroDiTelefono, U.Nome, U.Cognome,
                                S.Codice, S.TipologiaEmergenza,
                                R.Via, R.NumeroCivico, R.Città, R.Provincia, R.CAP, R.Data_Ora
        FROM UTENTI U,  SEGNALAZIONI S, RICHIESTE R
        WHERE 	R.NumTelefonicoUtente=U.NumeroDiTelefono AND
                R.NumTelefonicoUtente=:old.NumeroDiTelefono AND 	
                S.Codice=R.CodSegnalazione; 
    BEGIN 
        OPEN t_set; 
        LOOP 
            FETCH t_set INTO    tNumeroDiTelefono, tNome, tCognome,
                                tCodice, tTipologiaEmergenza,
                                tVia, tNumeroCivico, tCittà, tProvincia, tCAP, tData_Ora;
            INSERT INTO STORICO_SEGNALAZIONI
            VALUES( tNumeroDiTelefono, tNome, tCognome, tCodice, tTipologiaEmergenza, tVia, 
                    tNumeroCivico, tCittà, tProvincia, tCAP, tData_Ora); 
        END LOOP; 
        CLOSE t_set; 
        DELETE FROM RICHIESTE WHERE NumTelefonicoUtente=:old.NumeroDiTelefono;
    END;